<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 初识CATextLayer · RecherJ's blog</title><meta name="description" content="初识CATextLayer - RecherJ"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://recherj.github.io/atom.xml" title="RecherJ's blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://weibo.com/u/2698628733" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/RecherJ" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">初识CATextLayer</h1><div class="post-info">Feb 3, 2017</div><div class="post-content"><p>用户界面是无法从一个单独的图片里面构建的。一个设计良好的图标能够很好地表现一个按钮或控件的意图，不过你迟早都要需要一个不错的老式风格的文本标签。</p>
<a id="more"></a>
<p>如果你想在一个图层里面显示文字，完全可以借助图层代理直接将字符串使用 <code>Core Graphics</code> 写入图层的内 容(<strong>这就是UILabel的精髓</strong>)。如果越过寄宿于图层的视图,直接在图层上操作,那其实相当繁琐。你要为每一个显示文字的图层创建一个能像图层代理一样工作的类,还要逻辑上判断哪个图层需要显示哪个字符串,更别提还要记录不同的字体,颜色等一系列乱七八糟的东西。</p>
<p>万幸的是这些都是不必要的, <code>Core Animation</code> 提供了一个 <code>CALayer</code> 的子类 <code>CATextLayer</code> ,它以图层的形 式包含了 <code>UILabel</code> 几乎所有的绘制特性,并且额外提供了一些新的特性。</p>
<p>同样, <code>CATextLayer</code> 也要比 <code>UILabel</code> 渲染得快得多。很少有人知道在iOS 6及之前的版本, <code>UILabel</code> 其实是通过 <code>WebKit</code> 来实现绘制的，这样就造成了当有很多文字的时候就会有极大的性能压力。而<br><code>CATextLayer</code> 使用了 <code>Core text</code> ，并且渲染得非常快。</p>
<p>让我们来尝试用 <code>CATextLayer</code> 来显示一些文字。代码如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">@interface ViewController ()</span><br><span class="line">@property (nonatomic, weak) IBOutlet UIView *labelView; </span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation ViewController - (void)viewDidLoad</span><br><span class="line">&#123;</span><br><span class="line">	[super viewDidLoad];</span><br><span class="line">	</span><br><span class="line">	//create a text layer</span><br><span class="line">	CATextLayer *textLayer = [CATextLayer layer]; </span><br><span class="line">	textLayer.frame = self.labelView.bounds;</span><br><span class="line">	[self.labelView.layer addSublayer:textLayer];</span><br><span class="line">	</span><br><span class="line">	//set text attributes</span><br><span class="line">	textLayer.foregroundColor = [UIColor blackColor].CGColor; </span><br><span class="line">	textLayer.alignmentMode = 	kCAAlignmentJustified;</span><br><span class="line">	textLayer.wrapped = YES;</span><br><span class="line">	</span><br><span class="line">	//choose a font</span><br><span class="line">	UIFont *font = [UIFont systemFontOfSize:15];</span><br><span class="line">	</span><br><span class="line">	//set layer font</span><br><span class="line">	CFStringRef fontName = (__bridge CFStringRef)font.fontName; </span><br><span class="line">	CGFontRef fontRef = CGFontCreateWithFontName(fontName); </span><br><span class="line">	textLayer.font = fontRef;</span><br><span class="line">	textLayer.fontSize = font.pointSize;</span><br><span class="line">	CGFontRelease(fontRef);</span><br><span class="line">	</span><br><span class="line">	//choose some text</span><br><span class="line">	NSString *text = @"Lorem ipsum dolor sit amet, 	consectetur adipiscing \ </span><br><span class="line">	elit. Quisque massa arcu, el eifend vel varius in, facilisis pulvinar \ </span><br><span class="line">	leo. Nunc quis nunc at mauris pharetra condimentum ut ac neq ue. Nunc elementum, \</span><br><span class="line">	libero ut porttitor dictum, diam odio congue lacus, vel \ </span><br><span class="line">	fringilla sapien diam at purus. Etiam suscipit pretium nunc sit amet \ </span><br><span class="line">	lobortis";</span><br><span class="line">	</span><br><span class="line">	//set layer text</span><br><span class="line">	textLayer.string = text; </span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p><img src="https://ww4.sinaimg.cn/large/006tNc79ly1fcd4gdv906j30hn08hwgv.jpg" alt=""></p>
<p>如果你仔细看这个文本,你会发现一个奇怪的地方:这些文本有一些像素化了。这是因为并没有以 Retina 的方式渲染,第二章提到了这个 <code>contentScale</code> 属性,用来决定图层内容应该以怎样的分辨率来渲染。<br><code>contentsScale</code> 并不关心屏幕的拉伸因素而总是默认为1.0。如果我们想以Retina的质量来显示文字,我们 就得手动地设置 <code>CATextLayer</code> 的 <code>contentsScale</code> 属性,如下:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">textLayer.contentsScale = [<span class="built_in">UIScreen</span> mainScreen].scale;</span><br></pre></td></tr></table></figure>
<p>这样就解决了这个问题</p>
<p><img src="https://ww4.sinaimg.cn/large/006tNc79ly1fcd4hkwx3bj30ik09etbh.jpg" alt=""></p>
<p><code>CATextLayer</code> 的 font 属性不是一个 <code>UIFont</code> 类型,而是一个 <code>CFTypeRef</code> 类型。这样可以根据你的具体 需要来决定字体属性应该是用 CGFontRef 类型还是 CTFontRef 类型(Core Text字体)。同时字体大小 也是用 fontSize 属性单独设置的,因为 CTFontRef 和 CGFontRef 并不像UIFont一样包含点大小。这个 例子会告诉你如何将 UIFont 转换成 CGFontRef 。<br>另外, <code>CATextLayer</code> 的 <code>string</code> 属性并不是你想象的 <code>NSString</code> 类型,而是 <code>id</code> 类型。这样你既可以用 <code>NSString</code> 也可以用 <code>NSAttributedString</code> 来指定文本了(注意, <code>NSAttributedString</code> 并不是 <code>NSString</code><br>的子类)。属性化字符串是iOS用来渲染字体风格的机制,它以特定的方式来决定指定范围内的字符串的原 始信息,比如字体,颜色,字重,斜体等。</p>
<ul>
<li>摘录自译本：<a href="https://www.gitbook.com/book/zsisme/ios-/details" target="_blank" rel="external">《iOS核心动画高级技巧》</a></li>
<li>原著：<a href="https://www.amazon.com/iOS-Core-Animation-Advanced-Techniques-ebook/dp/B00EHJCORC/ref=sr_1_1?ie=UTF8&amp;qid=1423192842&amp;sr=8-1&amp;keywords=Core+Animation+Advanced+Techniques" target="_blank" rel="external">iOS Core Animation: Advanced Techniques</a></li>
</ul>
</div></article></div></main><footer><div class="paginator"><a href="/2018/05/06/重拾博客/" class="prev">PREV</a><a href="/2017/01/25/Shadowsocks配合Proxifier实现Mac全局科学上网/" class="next">NEXT</a></div><div class="copyright"><p>© 2016 - 2018 <a href="https://recherj.github.io">RecherJ</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>