<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Kingfisher加载gif问题 · RecherJ's blog</title><meta name="description" content="Kingfisher加载gif问题 - RecherJ"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://recherj.github.io/atom.xml" title="RecherJ's blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://weibo.com/u/2698628733" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/RecherJ" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Kingfisher加载gif问题</h1><div class="post-info">Jun 5, 2018</div><div class="post-content"><p>之前将我们的一款 Swift 项目中的图片库，从OC的 <a href="https://github.com/rs/SDWebImage" target="_blank" rel="noopener">SDWebImage</a> 换成了喵神写的 <a href="https://github.com/onevcat/Kingfisher" target="_blank" rel="noopener">Kingfisher</a> , 主要为了尽可能纯swift开发，混编编译实在是太慢了..</p>
<a id="more"></a>
<p>因为是一款电商App，自然少不了大量的图片，首页是仿淘宝模式利用UICollectionView实现的大量瀑布流的商品，产品需求要求增加对gif动图的实现。这个不难啊，迅速将UIImageView的图片换成了下面的模式</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">imageView.kf.setImage(with: <span class="type">URL</span>(string: imageURL))</span><br></pre></td></tr></table></figure>
<p>滚动起来发现卡的飞起，直接被产品怼回来了。。这个怎么可以？？so，问题出在哪了呢，简单查看了下源码发现，<code>KingfisherManager</code> 在 retrieveImage 时先判断cache中有没有，再去检查disk，如果都没有就调用 <code>ImageDownloader</code> 去异步下载，然后再主线程中回调给调用者，并在内存和disk中歌缓存一份。问题是，图片回来后的 decode 默认是在主线程中完成的，这样一来当 scrolling 时，就会发生资源抢夺，占用主线程导致感知到明显的卡顿（简直是就是掉帧，惨目忍睹😭），于是乎去翻了下 <code>KingfisherOptionsInfo.swift</code> 发现了 <code>.backgroundDecode</code> 属性</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Decode the image in background thread before using.</span></span><br><span class="line"><span class="keyword">case</span> backgroundDecode</span><br></pre></td></tr></table></figure>
<p>再将原来设置图片的方法改成了</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">imageView.kf.setImage(with: <span class="type">URL</span>(string: datas.squareImage), </span><br><span class="line">               placeholder: <span class="literal">nil</span>, </span><br><span class="line">                   options: [.backgroundDecode], </span><br><span class="line">             progressBlock: <span class="literal">nil</span>, </span><br><span class="line">         completionHandler: <span class="literal">nil</span>)</span><br></pre></td></tr></table></figure>
<p>换成了子线程中去 decode 后滚动测试，发现 everything gonna’ smoothly!! hold on , 怎么 gif 图不动了？？这都要上线了，出这种幺蛾子？？于是乎赶紧去 github 上看了看 issues ， 发现不止我一个人有遇到这种问题啊。找到了 <a href="https://github.com/onevcat/Kingfisher/issues/880" target="_blank" rel="noopener">Can’t play GIF with .backgroundDecode option</a> 和 作者的一个回复 <a href="https://github.com/onevcat/Kingfisher/issues/625" target="_blank" rel="noopener">.backgroundDecode not working with GIF</a> 。喵神大概意思是说 backgroundDecode 需要平衡内存和CPU的使用在两种模式下。于是就把自己的所有首页模板中的 UIImageView 全部改成继承自 <code>AnimatedUIImageView</code> 类，使用后卡顿的问题得到了解决，gif 图也可以正常动，但似乎卡顿还是存在，另外动图图片除了第一帧外其他压缩都很严重。</p>
<p>最终经过反复查阅头文件，找到了 <code>needsPrescaling</code> 和  <code>runLoopMode</code> 这两个属性。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Specifies whether the GIF frames should be pre-scaled to save memory. Default is true.</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">var</span> needsPrescaling = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// The animation timer's run loop mode. Default is `NSRunLoopCommonModes`. Set this property to `NSDefaultRunLoopMode` will make the animation pause during UIScrollView scrolling.</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">var</span> runLoopMode = <span class="type">RunLoopMode</span>.commonModes &#123;</span><br><span class="line">  <span class="keyword">willSet</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> runLoopMode == newValue &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      stopAnimating()</span><br><span class="line">      displayLink.remove(from: .main, forMode: runLoopMode)</span><br><span class="line">      displayLink.add(to: .main, forMode: newValue)</span><br><span class="line">      startAnimating()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将 <code>needsPrescaling</code> 设置为 false，并将 <code>runLoopMode</code> 改到 <code>.defaultRunLoopMode</code> 默认模式下，问题得到了解决。但卡顿掉帧还是存在，只是不那么明显了，后期再着重将这个问题再优化下。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2018/06/13/fastlane自动化打包部署/" class="prev">PREV</a><a href="/2018/06/03/仿淘宝购买页面/" class="next">NEXT</a></div><div class="copyright"><p>© 2016 - 2018 <a href="https://recherj.github.io">RecherJ</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>